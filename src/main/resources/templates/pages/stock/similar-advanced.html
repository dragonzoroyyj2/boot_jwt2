<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
  <meta charset="UTF-8">
  <title>ìœ ì‚¬ ì°¨íŠ¸ ì¢…ëª© ë¶„ì„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body {
      font-family: "Noto Sans KR", Arial, sans-serif;
      background-color: #f9fafb;
      color: #1f2937;
      margin: 0;
      padding: 0;
    }

    .content-container {
      max-width: 1500px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    h2 {
      font-size: 1.3rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 1rem;
    }

    .search-area {
      display: flex;
      flex-wrap: wrap;
      gap: 0.7rem;
      align-items: center;
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    input, button {
      padding: 0.6rem 0.8rem;
      font-size: 0.9rem;
      border-radius: 6px;
      border: 1px solid #d1d5db;
    }

    input {
      flex: 1;
      min-width: 150px;
    }

    button {
      background-color: #2563eb;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #1e40af;
    }

    table {
      width: 100%;
      margin-top: 1.5rem;
      border-collapse: collapse;
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    th, td {
      padding: 0.8rem 1rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      font-size: 0.9rem;
    }

    th {
      background-color: #f3f4f6;
      font-weight: 600;
    }

    tr:hover {
      background-color: #f9fafb;
    }

    .loading {
      display: none;
      margin-top: 1rem;
      text-align: center;
      font-size: 0.9rem;
      color: #2563eb;
    }

    .loading.active {
      display: block;
    }

    .warning {
      margin-top: 1rem;
      color: red;
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <h2>ğŸ“Š ìœ ì‚¬ ì°¨íŠ¸ ì¢…ëª© ë¶„ì„</h2>

    <!-- ê²€ìƒ‰/ë¶„ì„ ì˜ì—­ -->
    <div class="search-area">
      <input type="text" id="company" placeholder="ê¸°ì¤€ ì¢…ëª©ëª… (ì˜ˆ: ì¼€ì´ì—”ì•Œì‹œìŠ¤í…œ)" value="ì¼€ì´ì—”ì•Œì‹œìŠ¤í…œ">
      <input type="date" id="start" value="2024-03-07">
      <input type="date" id="end" value="2024-12-09">
      <button id="searchBtn"><i class="fa-solid fa-magnifying-glass"></i> ë¶„ì„ ì‹œì‘</button>
    </div>

    <!-- ë¡œë”©/ê²½ê³  ë©”ì‹œì§€ -->
    <div class="loading" id="loading">ğŸ” ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
    <div class="warning" id="warning"></div>

    <!-- ê²°ê³¼ í…Œì´ë¸” -->
    <table id="resultTable">
      <thead>
        <tr>
          <th>ì¢…ëª©ëª…</th>
          <th>ìœ ì‚¬ë„ ì ìˆ˜</th>
          <th>ë¹„êµê¸°ê°„ (ì¼ìˆ˜)</th>
          <th>ë°ì´í„° í¬ì¸íŠ¸</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<th:block layout:fragment="pageScript">
<script>
document.getElementById("searchBtn").addEventListener("click", () => {
  const company = document.getElementById("company").value.trim();
  const start = document.getElementById("start").value;
  const end = document.getElementById("end").value;
  const loading = document.getElementById("loading");
  const warning = document.getElementById("warning");
  const tbody = document.querySelector("#resultTable tbody");

  if (!company || !start || !end) {
    alert("ì¢…ëª©ëª…, ì‹œì‘ì¼, ì¢…ë£Œì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  tbody.innerHTML = "";
  warning.textContent = "";
  loading.classList.add("active");

  fetch(`/api/krx/similar-advanced?company=${encodeURIComponent(company)}&start=${start}&end=${end}`)
    .then(res => res.json())
    .then(data => {
      loading.classList.remove("active");

      if (!data || typeof data !== 'object') {
        alert("ê²°ê³¼ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      // warning ë©”ì‹œì§€ í‘œì‹œ
      if (data.warning) {
        warning.textContent = "âš  " + data.warning;
      }

      // ê²°ê³¼ í…Œì´ë¸” ì±„ìš°ê¸°
      if (Array.isArray(data.results)) {
        data.results.forEach(item => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.file || '-'}</td>
            <td>${item.similarity !== undefined ? item.similarity.toFixed(4) : '-'}</td>
            <td>${item.dates ? item.dates.length : '-'}</td>
            <td>${item.prices ? item.prices.length : '-'}</td>
          `;
          tbody.appendChild(tr);
        });
      }
    })
    .catch(err => {
      loading.classList.remove("active");
      warning.textContent = "âš  ë°ì´í„° ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      console.error(err);
    });
});
</script>
</th:block>
</body>
</html>
