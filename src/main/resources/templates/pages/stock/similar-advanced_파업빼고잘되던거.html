<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“Š ìœ ì‚¬ ì¢…ëª© ë¶„ì„</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/css/commonLayout.css">
  <link rel="stylesheet" href="/css/commonSearch.css">
  <link rel="stylesheet" href="/css/commonTable.css">

  <style>
    /* ===========================
       ì½˜í…ì¸  ì „ì²´ ì—¬ë°± í†µì¼
       =========================== */
    .content-container {
      padding-left: 1rem;
      padding-right: 1rem;
      box-sizing: border-box;
    }

    /* ===========================
       ê²€ìƒ‰ë¼ì¸
       =========================== */
    .search-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      align-items: center;
      padding: 0;
    }

    .search-row.single-line {
      flex-wrap: nowrap;
      overflow-x: auto;
    }

    /* 1ë²ˆì§¸ ì¤„: ì¢…ëª©ëª…, ì½”ë“œ, ì¢…ëª©ì°¾ê¸° */
    .stock-name-input {
      flex: 1;
      min-width: 120px;
      max-width: 100%;
      padding: 0.45rem 0.7rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    .stock-code-input {
      width: 90px;
      min-width: 60px;
      text-align: center;
      padding: 0.45rem 0.7rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    #openSearchPopupBtn {
      white-space: nowrap;
      padding: 0.45rem 0.7rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
    }

    /* ë²„íŠ¼ í­ì´ ì‘ìœ¼ë©´ ì•„ì´ì½˜ë§Œ */
    @media (max-width: 400px) {
      #openSearchPopupBtn {
        width: 35px;
        padding: 0.45rem;
      }
      #openSearchPopupBtn i { display: inline-block; }
      #openSearchPopupBtn span { display: none; }
    }

    /* 2ë²ˆì§¸ ì¤„: ë‚ ì§œ, nStocks, ë¶„ì„ */
    .search-row input[type=date],
    .search-row input[type=number],
    .search-row button {
      padding: 0.45rem 0.7rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      flex-shrink: 0;
    }

    .search-row input[type=date] {
      width: 120px;
      min-width: 80px;
    }

    .search-row input[type=number] {
      width: 60px; /* ìµœëŒ€ 3ìë¦¬ */
      min-width: 50px;
    }

    .search-row button {
      flex-shrink: 0;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
    }

    /* ë²„íŠ¼ ì•„ì´ì½˜ë§Œ í‘œì‹œ */
    @media (max-width: 400px) {
      .search-row:nth-child(2) button {
        width: 35px;
        padding: 0.45rem;
      }
      .search-row:nth-child(2) button i { display: inline-block; }
      .search-row:nth-child(2) button span { display: none; }
      .search-row:nth-child(2) input[type=date],
      .search-row:nth-child(2) input[type=number] {
        min-width: 60px;
        width: auto;
        flex: 1;
      }
    }

    /* ===========================
       í…Œì´ë¸” ì»¨í…Œì´ë„ˆ
       =========================== */
    .table-container {
      padding-left: 0;
      padding-right: 0;
      margin-top: 1rem;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }

    #resultTable tbody tr,
    #krxTableBody tr {
      border-bottom: 1px solid #d1d5db;
      cursor: pointer;
    }

    #loading {
      display: none;
      color: #2563eb;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    #warning {
      color: #dc2626;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    /* ===========================
       ëª¨ë‹¬ ê³µí†µ
       =========================== */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      overflow: auto;
    }

    .elegant-modal {
      background: #fff;
      margin: 5% auto;
      padding: 1rem;
      border-radius: 8px;
      max-width: 600px;
      position: relative;
    }

    .elegant-header { display: flex; justify-content: space-between; align-items: center; }
    .elegant-body { margin-top: 0.5rem; }
    .close-btn { cursor: pointer; font-size: 1.2rem; }

  </style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <h2>ğŸ“Š ìœ ì‚¬ ì¢…ëª© ë¶„ì„</h2>

    <!-- 1ë²ˆì§¸ ì¤„ -->
    <div class="search-row single-line">
      <input type="text" id="company" class="stock-name-input" placeholder="ê¸°ì¤€ ì¢…ëª©ëª…" value="ì¼€ì´ì—”ì•Œì‹œìŠ¤í…œ">
      <input type="text" id="companyCode" class="stock-code-input" placeholder="í‹°ì»¤ ì½”ë“œ" value="199430">
      <button id="openSearchPopupBtn" class="btn"><i class="fas fa-search"></i><span> ì¢…ëª©ì°¾ê¸°</span></button>
    </div>

    <!-- 2ë²ˆì§¸ ì¤„ -->
    <div class="search-row">
      <input type="date" id="start" value="2024-03-07">
      <input type="date" id="end" value="2024-12-09">
      <input type="number" id="nStocks" placeholder="ìœ ì‚¬ ì¢…ëª© ìˆ˜" value="10" max="999">
      <button id="searchBtn" class="btn"><i class="fas fa-chart-line"></i><span> ë¶„ì„</span></button>
    </div>

    <!-- ë¡œë”© / ê²½ê³  -->
    <div id="loading">ğŸ” ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>
    <div id="warning"></div>

    <!-- ê²°ê³¼ í…Œì´ë¸” -->
    <div class="table-container">
      <table id="resultTable">
        <thead>
        <tr>
          <th>í‹°ì»¤</th>
          <th>ì¢…ëª©ëª…</th>
          <th>ìœ ì‚¬ë„(%)</th>
        </tr>
        </thead>
        <tbody id="resultTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- KRX ì¢…ëª© íŒì—… -->
  <div class="modal" id="stockLayerPopup">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3>KRX ì¢…ëª© ì¡°íšŒ</h3>
        <span class="close-btn" data-close="stockLayerPopup">&times;</span>
      </div>
      <div class="elegant-body">
        <div class="toolbar">
          <input type="text" id="searchInput" placeholder="íšŒì‚¬ëª… ê²€ìƒ‰">
          <button id="fetchBtn" class="btn"><i class="fas fa-search"></i> ì¡°íšŒ</button>
        </div>
        <div class="table-container" style="max-height:400px; overflow-y:auto;">
          <table>
            <thead>
            <tr>
              <th>í‹°ì»¤</th>
              <th>íšŒì‚¬ëª…</th>
              <th>ìƒì¥ì¼</th>
              <th>ì—…ì¢…</th>
              <th>ëŒ€í‘œì</th>
            </tr>
            </thead>
            <tbody id="krxTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ì°¨íŠ¸ íŒì—… -->
  <div class="modal" id="chartPopup">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3>ìœ ì‚¬ ì¢…ëª© ì°¨íŠ¸</h3>
        <span class="close-btn" data-close="chartPopup">&times;</span>
      </div>
      <div class="elegant-body">
        <img id="chartImage" src="" alt="ì°¨íŠ¸ ì´ë¯¸ì§€" style="max-width:100%;border-radius:8px;">
      </div>
    </div>
  </div>

</div>

<th:block layout:fragment="pageScript">
<script>
document.addEventListener("DOMContentLoaded", () => {
  const companyInput = document.getElementById("company");
  const companyCodeInput = document.getElementById("companyCode");
  const startInput = document.getElementById("start");
  const endInput = document.getElementById("end");
  const nStocksInput = document.getElementById("nStocks");
  const searchBtn = document.getElementById("searchBtn");
  const loading = document.getElementById("loading");
  const warning = document.getElementById("warning");
  const resultTableBody = document.getElementById("resultTableBody");

  const layerPopup = document.getElementById("stockLayerPopup");
  const openPopupBtn = document.getElementById("openSearchPopupBtn");
  const closeBtns = document.querySelectorAll("[data-close]");
  const searchInput = document.getElementById("searchInput");
  const fetchBtn = document.getElementById("fetchBtn");
  const krxTableBody = document.getElementById("krxTableBody");

  const chartPopup = document.getElementById("chartPopup");
  const chartImage = document.getElementById("chartImage");

  let allKrxStocks = [];

  // íŒì—… ì—´ê¸°
  openPopupBtn.addEventListener("click", () => layerPopup.style.display = "block");

  // íŒì—… ë‹«ê¸°
  closeBtns.forEach(btn => {
    btn.addEventListener("click", e => {
      const id = e.target.dataset.close;
      document.getElementById(id).style.display = "none";
    });
  });

  // KRX ì¡°íšŒ
  fetchBtn.addEventListener("click", () => {
    fetchBtn.disabled = true;
    fetchBtn.textContent = "ì¡°íšŒ ì¤‘...";
    fetch("/api/krx")
      .then(res => res.json())
      .then(data => {
        allKrxStocks = data;
        renderKrxTable(allKrxStocks);
        fetchBtn.disabled = false;
        fetchBtn.textContent = "ì¡°íšŒ";
      })
      .catch(err => {
        console.error(err);
        fetchBtn.disabled = false;
        fetchBtn.textContent = "ì¡°íšŒ";
        alert("KRX ì¡°íšŒ ì‹¤íŒ¨");
      });
  });

  function renderKrxTable(data) {
    krxTableBody.innerHTML = "";
    data.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.code || ""}</td>
        <td>${item.name || ""}</td>
        <td>${item.listedDate || ""}</td>
        <td>${item.sector || ""}</td>
        <td>${item.ceo || ""}</td>
      `;
      tr.addEventListener("click", () => {
        companyInput.value = item.name;
        companyCodeInput.value = item.code;
        layerPopup.style.display = "none";
      });
      krxTableBody.appendChild(tr);
    });
  }

  // ê²€ìƒ‰ í•„í„°
  searchInput.addEventListener("keyup", e => {
    const keyword = e.target.value.toLowerCase();
    renderKrxTable(allKrxStocks.filter(item =>
      item.name.toLowerCase().includes(keyword) ||
      item.code.toLowerCase().includes(keyword)
    ));
  });

  // ìœ ì‚¬ì¢…ëª© ë¶„ì„
  searchBtn.addEventListener("click", () => {
    const companyCode = companyCodeInput.value;
    const start = startInput.value;
    const end = endInput.value;
    const nStocks = nStocksInput.value;

    if (!companyCode || !start || !end) {
      warning.textContent = "âš ï¸ ê¸°ì¤€ ì¢…ëª©ê³¼ ë‚ ì§œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.";
      return;
    }

    loading.style.display = "block";
    warning.textContent = "";
    resultTableBody.innerHTML = "";

    fetch(`/api/krx/similar-advanced?companyCode=${companyCode}&start=${start}&end=${end}&nSimilarStocks=${nStocks}`)
    .then(res => res.json())
    .then(data => {
      loading.style.display = "none";

      if (!data || !Array.isArray(data.similar_stocks)) {
        warning.textContent = "ë¶„ì„ ì‹¤íŒ¨ (ì‘ë‹µ ë°ì´í„° ì˜¤ë¥˜)";
        console.error("ì„œë²„ ì‘ë‹µ:", data);
        return;
      }

      resultTableBody.innerHTML = "";
      data.similar_stocks.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.code || ""}</td>
          <td>${item.name || ""}</td>
          <td>${(item.cosine_similarity * 100).toFixed(2)}%</td>
        `;

        tr.addEventListener("click", () => {
          chartPopup.style.display = "block";
          chartImage.src = "";
          chartImage.alt = "ì°¨íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

          fetch(`/api/krx/similar-advanced/chart?baseSymbol=${companyCode}&compareSymbol=${item.code}&start=${start}&end=${end}`)
            .then(res => res.json())
            .then(chartData => {
              if (chartData && chartData.image_data) {
                chartImage.src = `data:image/png;base64,${chartData.image_data}`;
              } else {
                chartImage.alt = "ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
              }
            })
            .catch(err => {
              console.error(err);
              chartImage.alt = "ì°¨íŠ¸ ë¡œë”© ì˜¤ë¥˜";
            });
        });

        resultTableBody.appendChild(tr);
      });
    })
    .catch(err => {
      console.error(err);
      loading.style.display = "none";
      warning.textContent = "ì„œë²„ ì˜¤ë¥˜";
    });
});

// ë¡œë”© ì·¨ì†Œ ê¸°ëŠ¥ (í´ë¦­í•˜ë©´ ë¡œë”© ì¤‘ì´ë©´ ì·¨ì†Œ)
loading.addEventListener("click", () => {
  loading.style.display = "none";
  warning.textContent = "ë¶„ì„ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.";
  // ì‹¤ì œ fetch ì·¨ì†ŒëŠ” AbortController ì‚¬ìš© ê°€ëŠ¥
});

});
</script>
</th:block>
</body>
</html>

