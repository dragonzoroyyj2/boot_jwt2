<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
  <meta charset="UTF-8">
  <title>📊 유사 종목 분석</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/css/commonLayout.css">
  <link rel="stylesheet" href="/css/commonSearch.css">
  <link rel="stylesheet" href="/css/commonTable.css">

  <style>
    /* ===========================
       콘텐츠 전체 여백 통일
       =========================== */
    .content-container {
      padding-left: 1rem;
      padding-right: 1rem;
      box-sizing: border-box;
    }

    /* ===========================
       검색라인
       =========================== */
    .search-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      align-items: center;
      padding: 0;
    }

    .search-row.single-line {
      flex-wrap: nowrap;
      overflow-x: auto;
    }

    /* 1번째 줄: 종목명, 코드, 종목찾기 */
    .stock-name-input {
      flex: 1;
      min-width: 120px;
      max-width: 100%;
      padding: 0.45rem 0.7rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    .stock-code-input {
      width: 90px;
      min-width: 60px;
      text-align: center;
      padding: 0.45rem 0.7rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    #openSearchPopupBtn {
      white-space: nowrap;
      padding: 0.45rem 0.7rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
    }

    /* 버튼 폭이 작으면 아이콘만 */
    @media (max-width: 400px) {
      #openSearchPopupBtn {
        width: 35px;
        padding: 0.45rem;
      }
      #openSearchPopupBtn i { display: inline-block; }
      #openSearchPopupBtn span { display: none; }
    }

    /* 2번째 줄: 날짜, nStocks, 분석 */
    .search-row input[type=date],
    .search-row input[type=number],
    .search-row button {
      padding: 0.45rem 0.7rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      flex-shrink: 0;
    }

    .search-row input[type=date] {
      width: 120px;
      min-width: 80px;
    }

    .search-row input[type=number] {
      width: 60px; /* 최대 3자리 */
      min-width: 50px;
    }

    .search-row button {
      flex-shrink: 0;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
    }

    /* 버튼 아이콘만 표시 */
    @media (max-width: 400px) {
      .search-row:nth-child(2) button {
        width: 35px;
        padding: 0.45rem;
      }
      .search-row:nth-child(2) button i { display: inline-block; }
      .search-row:nth-child(2) button span { display: none; }
      .search-row:nth-child(2) input[type=date],
      .search-row:nth-child(2) input[type=number] {
        min-width: 60px;
        width: auto;
        flex: 1;
      }
    }

    /* ===========================
       테이블 컨테이너
       =========================== */
    .table-container {
      padding-left: 0;
      padding-right: 0;
      margin-top: 1rem;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }

    #resultTable tbody tr,
    #krxTableBody tr {
      border-bottom: 1px solid #d1d5db;
      cursor: pointer;
    }

    #loading {
      display: none;
      color: #2563eb;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    #warning {
      color: #dc2626;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    /* ===========================
       모달 공통
       =========================== */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      overflow: auto;
    }

    .elegant-modal {
      background: #fff;
      margin: 5% auto;
      padding: 1rem;
      border-radius: 8px;
      max-width: 600px;
      position: relative;
    }

    .elegant-header { display: flex; justify-content: space-between; align-items: center; }
    .elegant-body { margin-top: 0.5rem; }
    .close-btn { cursor: pointer; font-size: 1.2rem; }

  </style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <h2>📊 유사 종목 분석</h2>

    <!-- 1번째 줄 -->
    <div class="search-row single-line">
      <input type="text" id="company" class="stock-name-input" placeholder="기준 종목명" value="케이엔알시스템">
      <input type="text" id="companyCode" class="stock-code-input" placeholder="티커 코드" value="199430">
      <button id="openSearchPopupBtn" class="btn"><i class="fas fa-search"></i><span> 종목찾기</span></button>
    </div>

    <!-- 2번째 줄 -->
    <div class="search-row">
      <input type="date" id="start" value="2024-03-07">
      <input type="date" id="end" value="2024-12-09">
      <input type="number" id="nStocks" placeholder="유사 종목 수" value="10" max="999">
      <button id="searchBtn" class="btn"><i class="fas fa-chart-line"></i><span> 분석</span></button>
    </div>

    <!-- 로딩 / 경고 -->
    <div id="loading">🔍 분석 중입니다...</div>
    <div id="warning"></div>

    <!-- 결과 테이블 -->
    <div class="table-container">
      <table id="resultTable">
        <thead>
        <tr>
          <th>티커</th>
          <th>종목명</th>
          <th>유사도(%)</th>
        </tr>
        </thead>
        <tbody id="resultTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- KRX 종목 팝업 -->
  <div class="modal" id="stockLayerPopup">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3>KRX 종목 조회</h3>
        <span class="close-btn" data-close="stockLayerPopup">&times;</span>
      </div>
      <div class="elegant-body">
        <div class="toolbar">
          <input type="text" id="searchInput" placeholder="회사명 검색">
          <button id="fetchBtn" class="btn"><i class="fas fa-search"></i> 조회</button>
        </div>
        <div class="table-container" style="max-height:400px; overflow-y:auto;">
          <table>
            <thead>
            <tr>
              <th>티커</th>
              <th>회사명</th>
              <th>상장일</th>
              <th>업종</th>
              <th>대표자</th>
            </tr>
            </thead>
            <tbody id="krxTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 차트 팝업 -->
  <div class="modal" id="chartPopup">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3>유사 종목 차트</h3>
        <span class="close-btn" data-close="chartPopup">&times;</span>
      </div>
      <div class="elegant-body">
        <img id="chartImage" src="" alt="차트 이미지" style="max-width:100%;border-radius:8px;">
      </div>
    </div>
  </div>

</div>

<th:block layout:fragment="pageScript">
<script>
document.addEventListener("DOMContentLoaded", () => {
  const companyInput = document.getElementById("company");
  const companyCodeInput = document.getElementById("companyCode");
  const startInput = document.getElementById("start");
  const endInput = document.getElementById("end");
  const nStocksInput = document.getElementById("nStocks");
  const searchBtn = document.getElementById("searchBtn");
  const loading = document.getElementById("loading");
  const warning = document.getElementById("warning");
  const resultTableBody = document.getElementById("resultTableBody");

  const layerPopup = document.getElementById("stockLayerPopup");
  const openPopupBtn = document.getElementById("openSearchPopupBtn");
  const closeBtns = document.querySelectorAll("[data-close]");
  const searchInput = document.getElementById("searchInput");
  const fetchBtn = document.getElementById("fetchBtn");
  const krxTableBody = document.getElementById("krxTableBody");

  const chartPopup = document.getElementById("chartPopup");
  const chartImage = document.getElementById("chartImage");

  let allKrxStocks = [];

  // 팝업 열기
  openPopupBtn.addEventListener("click", () => layerPopup.style.display = "block");

  // 팝업 닫기
  closeBtns.forEach(btn => {
    btn.addEventListener("click", e => {
      const id = e.target.dataset.close;
      document.getElementById(id).style.display = "none";
    });
  });

  // KRX 조회
  fetchBtn.addEventListener("click", () => {
    fetchBtn.disabled = true;
    fetchBtn.textContent = "조회 중...";
    fetch("/api/krx")
      .then(res => res.json())
      .then(data => {
        allKrxStocks = data;
        renderKrxTable(allKrxStocks);
        fetchBtn.disabled = false;
        fetchBtn.textContent = "조회";
      })
      .catch(err => {
        console.error(err);
        fetchBtn.disabled = false;
        fetchBtn.textContent = "조회";
        alert("KRX 조회 실패");
      });
  });

  function renderKrxTable(data) {
    krxTableBody.innerHTML = "";
    data.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.code || ""}</td>
        <td>${item.name || ""}</td>
        <td>${item.listedDate || ""}</td>
        <td>${item.sector || ""}</td>
        <td>${item.ceo || ""}</td>
      `;
      tr.addEventListener("click", () => {
        companyInput.value = item.name;
        companyCodeInput.value = item.code;
        layerPopup.style.display = "none";
      });
      krxTableBody.appendChild(tr);
    });
  }

  // 검색 필터
  searchInput.addEventListener("keyup", e => {
    const keyword = e.target.value.toLowerCase();
    renderKrxTable(allKrxStocks.filter(item =>
      item.name.toLowerCase().includes(keyword) ||
      item.code.toLowerCase().includes(keyword)
    ));
  });

  // 유사종목 분석
  searchBtn.addEventListener("click", () => {
    const companyCode = companyCodeInput.value;
    const start = startInput.value;
    const end = endInput.value;
    const nStocks = nStocksInput.value;

    if (!companyCode || !start || !end) {
      warning.textContent = "⚠️ 기준 종목과 날짜를 모두 입력해주세요.";
      return;
    }

    loading.style.display = "block";
    warning.textContent = "";
    resultTableBody.innerHTML = "";

    fetch(`/api/krx/similar-advanced?companyCode=${companyCode}&start=${start}&end=${end}&nSimilarStocks=${nStocks}`)
    .then(res => res.json())
    .then(data => {
      loading.style.display = "none";

      if (!data || !Array.isArray(data.similar_stocks)) {
        warning.textContent = "분석 실패 (응답 데이터 오류)";
        console.error("서버 응답:", data);
        return;
      }

      resultTableBody.innerHTML = "";
      data.similar_stocks.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.code || ""}</td>
          <td>${item.name || ""}</td>
          <td>${(item.cosine_similarity * 100).toFixed(2)}%</td>
        `;

        tr.addEventListener("click", () => {
          chartPopup.style.display = "block";
          chartImage.src = "";
          chartImage.alt = "차트 불러오는 중...";

          fetch(`/api/krx/similar-advanced/chart?baseSymbol=${companyCode}&compareSymbol=${item.code}&start=${start}&end=${end}`)
            .then(res => res.json())
            .then(chartData => {
              if (chartData && chartData.image_data) {
                chartImage.src = `data:image/png;base64,${chartData.image_data}`;
              } else {
                chartImage.alt = "차트 데이터를 불러오지 못했습니다.";
              }
            })
            .catch(err => {
              console.error(err);
              chartImage.alt = "차트 로딩 오류";
            });
        });

        resultTableBody.appendChild(tr);
      });
    })
    .catch(err => {
      console.error(err);
      loading.style.display = "none";
      warning.textContent = "서버 오류";
    });
});

// 로딩 취소 기능 (클릭하면 로딩 중이면 취소)
loading.addEventListener("click", () => {
  loading.style.display = "none";
  warning.textContent = "분석이 취소되었습니다.";
  // 실제 fetch 취소는 AbortController 사용 가능
});

});
</script>
</th:block>
</body>
</html>

