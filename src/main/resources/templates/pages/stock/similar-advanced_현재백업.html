<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
  <meta charset="UTF-8">
  <title>유사 종목 분석</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- 공용 CSS -->
  <link rel="stylesheet" href="/css/commonLayout.css">
  <link rel="stylesheet" href="/css/commonSearch.css">
  <link rel="stylesheet" href="/css/commonTable.css">
  <style>
    /* 추가 스타일 */
    .search-row { display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.5rem; }
    .search-row .search-group { display:flex; flex-wrap:wrap; gap:0.5rem; flex:1; }
    .search-row input[type=text], .search-row input[type=date], .search-row input[type=number], .search-row button { padding:0.45rem 0.7rem; border-radius:6px; border:1px solid #ccc; }
    .table-container { margin-top:1rem; }
    #resultTable tbody tr { border-bottom:1px solid #d1d5db; cursor:pointer; }
    #krxTableBody tr { border-bottom:1px solid #d1d5db; cursor:pointer; }
    @media (max-width:768px) { .search-row { flex-direction:column; } .search-row .search-group { flex-direction:column; } }
  </style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <h2>유사 종목 분석</h2>

    <!-- 1번째 줄: 기준 종목명, 티커코드, 종목찾기 -->
    <div class="search-row">
      <div class="search-group">
        <input type="text" id="company" placeholder="기준 종목명" value="케이엔알시스템">
        <input type="text" id="companyCode" placeholder="티커 코드" value="199430">
        <button id="openSearchPopupBtn" class="btn"><i class="fas fa-search"></i> 종목찾기</button>
      </div>
    </div>

    <!-- 2번째 줄: 시작일, 종료일, 유사종목 수, 분석 -->
    <div class="search-row">
      <input type="date" id="start" value="2024-03-07">
      <input type="date" id="end" value="2024-12-09">
      <input type="number" id="nStocks" placeholder="유사 종목 수" value="10">
      <button id="searchBtn" class="btn"><i class="fas fa-chart-line"></i> 분석</button>
    </div>

    <div class="loading" id="loading">분석 중입니다...</div>
    <div class="warning" id="warning"></div>

    <!-- 결과 테이블 -->
    <div class="table-container">
      <table id="resultTable">
        <thead>
          <tr>
            <th>티커</th>
            <th>종목명</th>
            <th>유사도(%)</th>
          </tr>
        </thead>
        <tbody id="resultTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- KRX 종목 레이어 팝업 -->
  <div class="modal" id="stockLayerPopup">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3>KRX 종목 조회</h3>
        <span class="close-btn" data-close="stockLayerPopup">&times;</span>
      </div>
      <div class="elegant-body">
        <div class="toolbar">
          <input type="text" id="searchInput" placeholder="회사명 검색">
          <button id="fetchBtn" class="btn"><i class="fas fa-search"></i> 조회</button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>티커</th>
                <th>회사명</th>
                <th>상장일</th>
                <th>업종</th>
                <th>대표자</th>
              </tr>
            </thead>
            <tbody id="krxTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 차트 레이어 팝업 -->
  <div class="modal" id="chartPopup">
    <div class="elegant-modal">
      <div class="elegant-header">
        <h3>유사 종목 차트</h3>
        <span class="close-btn" data-close="chartPopup">&times;</span>
      </div>
      <div class="elegant-body">
        <img id="chartImage" src="" alt="차트 이미지">
      </div>
    </div>
  </div>
</div>

<th:block layout:fragment="pageScript">
<script>
document.addEventListener("DOMContentLoaded", ()=>{
  const companyInput=document.getElementById("company");
  const companyCodeInput=document.getElementById("companyCode");
  const startInput=document.getElementById("start");
  const endInput=document.getElementById("end");
  const nStocksInput=document.getElementById("nStocks");
  const searchBtn=document.getElementById("searchBtn");
  const loading=document.getElementById("loading");
  const warning=document.getElementById("warning");
  const resultTableBody=document.getElementById("resultTableBody");

  const layerPopup=document.getElementById("stockLayerPopup");
  const openPopupBtn=document.getElementById("openSearchPopupBtn");
  const closeBtns=document.querySelectorAll("[data-close]");
  const searchInput=document.getElementById("searchInput");
  const fetchBtn=document.getElementById("fetchBtn");
  const krxTableBody=document.getElementById("krxTableBody");

  const chartPopup=document.getElementById("chartPopup");
  const chartImage=document.getElementById("chartImage");

  let allKrxStocks=[];

  // 팝업 열기/닫기
  openPopupBtn.addEventListener("click", ()=>layerPopup.style.display="block");
  closeBtns.forEach(btn=>{
    btn.addEventListener("click", e=>{
      const id=e.target.dataset.close;
      document.getElementById(id).style.display="none";
    });
  });

  // KRX 조회
  fetchBtn.addEventListener("click", ()=>{
    fetchBtn.disabled=true; fetchBtn.textContent="조회 중...";
    fetch("/api/krx")
      .then(res=>res.json())
      .then(data=>{
        allKrxStocks=data;
        renderKrxTable(allKrxStocks);
        fetchBtn.disabled=false; fetchBtn.textContent="조회";
      }).catch(err=>{
        console.error(err); fetchBtn.disabled=false; fetchBtn.textContent="조회";
        alert("KRX 조회 실패");
      });
  });

  function renderKrxTable(data){
    krxTableBody.innerHTML="";
    data.forEach(item=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${item.ticker||''}</td><td>${item.name||''}</td><td>${item.listingDate||''}</td><td>${item.sector||''}</td><td>${item.representative||''}</td>`;
      tr.addEventListener("click", ()=>{
        companyInput.value=item.name;
        companyCodeInput.value=item.ticker;
        layerPopup.style.display="none";
      });
      krxTableBody.appendChild(tr);
    });
  }

  searchInput.addEventListener("keyup", e=>{
    const keyword=e.target.value.toLowerCase();
    renderKrxTable(allKrxStocks.filter(item=>item.name.toLowerCase().includes(keyword) || item.ticker.toLowerCase().includes(keyword)));
  });

  // 유사 종목 분석
  searchBtn.addEventListener("click", ()=>{
    const companyCode=companyCodeInput.value, start=startInput.value, end=endInput.value, nStocks=nStocksInput.value;
    if(!companyCode || !start || !end){ warning.textContent="기준 종목, 날짜를 모두 입력해주세요"; return; }

    loading.style.display="block"; warning.textContent=""; resultTableBody.innerHTML="";

    fetch(`/api/krx/similar-advanced?companyCode=${companyCode}&start=${start}&end=${end}&nSimilarStocks=${nStocks}`)
      .then(res=>res.json())
      .then(data=>{
        loading.style.display="none";
       

     // 수정
     if(Array.isArray(data.similar_stocks)){
         resultTableBody.innerHTML = "";
         data.similar_stocks.forEach(item => {
             const tr = document.createElement("tr");
             tr.style.cursor = "pointer";
             tr.innerHTML = `
               <td>${item.name || ""}</td>
               <td>${item.ticker || ""}</td>
               <td>${(item.cosine_similarity*100).toFixed(2)}%</td>
             `;
             resultTableBody.appendChild(tr);
         });
     } else {
         warning.textContent = "분석 실패";
     }
        
      }).catch(err=>{
        console.error(err); loading.style.display="none"; warning.textContent="서버 오류";
      });
  });
});
</script>
</th:block>
</body>
</html>
