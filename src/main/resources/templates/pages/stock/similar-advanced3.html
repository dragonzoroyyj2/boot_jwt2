<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>유사 차트 종목 분석</title>
  <style>
    body { font-family: "Noto Sans KR", Arial, sans-serif; margin:0; padding:0; background:#f9fafb; color:#111827; }
    .content-container { max-width: 1500px; margin: 0 auto; padding: 1rem; }
    h2 { font-size: 1.3rem; margin-bottom: 1rem; }
    .search-area { display: flex; flex-wrap: wrap; gap:0.5rem; align-items:center; margin-bottom:1rem; }
    .search-input-group { display: flex; flex-grow: 1; align-items: center; gap: 0.5rem; } /* 🟢 그룹화 */
    input, button { padding:0.5rem; font-size:0.9rem; border-radius:5px; border:1px solid #d1d5db; }
    input#company { flex: 1; }
    input#companyCode { width: 100px; background: #e9ecef; } /* 🟢 티커 코드 필드 스타일 */
    button { background:#2563eb; color:white; border:none; cursor:pointer; }
    button:hover { background:#1e40af; }
    table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; }
    th, td { padding:0.6rem 0.8rem; border-bottom:1px solid #e5e7eb; text-align:left; font-size:0.9rem; }
    th { background:#f3f4f6; font-weight:600; }
    tr:hover { background:#f9fafb; }
    .loading { display:none; margin-top:1rem; font-size:0.9rem; color:#2563eb; }
    .loading.active { display:block; }
    .warning { margin-top:1rem; color:red; font-size:0.9rem; }
  </style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
    <h2>유사 차트 종목 분석</h2>

    <div class="search-area">
      <div class="search-input-group"> <!-- 🟢 그룹화 -->
        <input type="text" id="company" placeholder="기준 종목명" value="케이엔알시스템">
        <input type="text" id="companyCode" placeholder="티커 코드" readonly>
        <button id="openSearchPopupBtn">종목 찾기</button>
      </div>
      <input type="date" id="start" value="2024-03-07">
      <input type="date" id="end" value="2024-12-09">
      <button id="searchBtn">분석 시작</button>
    </div>

    <div class="loading" id="loading">분석 중입니다...</div>
    <div class="warning" id="warning"></div>

    <table>
      <thead>
        <tr>
          <th>종목명 (티커)</th>
          <th>유사도 점수</th>
          <th>비교기간 (일수)</th>
          <th>데이터 포인트</th>
        </tr>
      </thead>
      <tbody id="resultTableBody"></tbody>
    </table>
  </div>
</div>

<th:block layout:fragment="pageScript">
<script>
document.addEventListener("DOMContentLoaded", () => {
    const searchBtn = document.getElementById("searchBtn");
    const openSearchPopupBtn = document.getElementById("openSearchPopupBtn");
    const companyInput = document.getElementById("company");
    const companyCodeInput = document.getElementById("companyCode");
    const loading = document.getElementById("loading");
    const warning = document.getElementById("warning");
    const tbody = document.getElementById("resultTableBody");

    // 🟢 팝업 버튼 클릭 이벤트
    openSearchPopupBtn.addEventListener("click", () => {
        window.open("/stock_search_popup.html", "StockSearch", "width=800,height=600");
    });

    // 🟢 팝업에서 전달된 데이터 수신
    window.addEventListener("message", (event) => {
        if (event.origin !== window.location.origin) { return; }
        if (event.data.companyCode) {
            companyInput.value = event.data.company;
            companyCodeInput.value = event.data.companyCode;
        }
    });

    searchBtn.addEventListener("click", () => {
        const companyCode = companyCodeInput.value.trim();
        const start = document.getElementById("start").value;
        const end = document.getElementById("end").value;
        if (!companyCode || !start || !end) { alert("모든 필드를 입력해주세요."); return; }

        tbody.innerHTML = "";
        warning.textContent = "";
        loading.classList.add("active");

        fetch(`/api/krx/similar-advanced?company=${encodeURIComponent(companyCode)}&start=${start}&end=${end}`)
            .then(res => res.json())
            .then(data => {
                loading.classList.remove("active");
                if (!data || !data.results) { warning.textContent="결과 데이터가 없습니다."; return; }

                if (data.warning) warning.textContent = data.warning;

                data.results.forEach(item => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${item.ticker || '-'}</td>
                        <td>${item.similarity_score !== undefined ? item.similarity_score.toFixed(4) : '-'}</td>
                        <td>${item.comparison_days || '-'}</td>
                        <td>${item.comparison_days || '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(err => {
                loading.classList.remove("active");
                warning.textContent = "데이터 분석 중 오류가 발생했습니다.";
                console.error(err);
            });
    });
});
</script>
</th:block>
</body>
</html>
