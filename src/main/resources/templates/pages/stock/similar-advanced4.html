<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>유사 차트 종목 분석</title>
  <style>
    /* ===== 기본 스타일 ===== */
    body { font-family: "Noto Sans KR", Arial, sans-serif; margin:0; padding:0; background:#f9fafb; color:#111827; }
    .content-container { max-width: 1500px; margin: 0 auto; padding: 1rem; }
    h2 { font-size: 1.3rem; margin-bottom: 1rem; }
    .search-area { display: flex; flex-wrap: wrap; gap:0.5rem; align-items:center; margin-bottom:1rem; }
    .search-input-group { display: flex; flex-grow: 1; align-items: center; gap: 0.5rem; }
    input, button { padding:0.5rem; font-size:0.9rem; border-radius:5px; border:1px solid #d1d5db; }
    input#company { flex: 1; }
    input#companyCode { width: 100px; background: #e9ecef; }
    button { background:#2563eb; color:white; border:none; cursor:pointer; }
    button:hover { background:#1e40af; }
    table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; }
    th, td { padding:0.6rem 0.8rem; border-bottom:1px solid #e5e7eb; text-align:left; font-size:0.9rem; }
    th { background:#f3f4f6; font-weight:600; }
    tr:hover { background:#f9fafb; }
    .loading { display:none; margin-top:1rem; font-size:0.9rem; color:#2563eb; }
    .loading.active { display:block; }
    .warning { margin-top:1rem; color:red; font-size:0.9rem; }

    /* ===== 레이어 팝업 스타일 ===== */
    #layerBackdrop {
      display:none;
      position:fixed;
      top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      z-index:999;
    }
    #stockLayerPopup {
      display:none;
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%, -50%);
      width:90%; max-width:1000px;
      max-height:80%;
      overflow-y:auto;
      background:#fff;
      border-radius:10px;
      padding:1rem;
      z-index:1000;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    #stockLayerPopup table { width:100%; border-collapse:collapse; }
    #stockLayerPopup th, #stockLayerPopup td { padding:0.5rem; border-bottom:1px solid #e5e7eb; font-size:0.9rem; }
    #stockLayerPopup th { background:#f3f4f6; font-weight:600; }
    #stockLayerPopup tr:hover { background:#f9fafb; }
    #stockLayerPopup .popup-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem; }
    #stockLayerPopup .popup-header h3 { margin:0; font-size:1.1rem; }
    #stockLayerPopup .popup-header button { padding:0.2rem 0.5rem; font-size:0.9rem; }
    @media (max-width:1024px){
      table, thead, tbody, th, td, tr { display:block; }
      th { display:none; }
      td { border:none; position:relative; padding-left:50%; }
      td::before { content:attr(data-label); position:absolute; left:1rem; font-weight:600; }
    }
  </style>
</head>

<body>
<div layout:fragment="content">
  <div class="content-container">
  <h2>유사 차트 종목 분석</h2>

  <!-- 검색 영역 -->
  <div class="search-area">
    <div class="search-input-group">
      <input type="text" id="company" placeholder="기준 종목명" value="케이엔알시스템">
      <input type="text" id="companyCode" placeholder="티커 코드" value="005930.KS">
      <button id="openSearchPopupBtn">종목 찾기</button>
    </div>
    <input type="date" id="start" value="2024-03-07">
    <input type="date" id="end" value="2024-12-09">
    <input type="number" id="nStocks" placeholder="유사 종목 수" value="10">
    <button id="searchBtn">분석 시작</button>
  </div>

  <!-- 로딩/경고 메시지 -->
  <div class="loading" id="loading">분석 중입니다...</div>
  <div class="warning" id="warning"></div>

  <!-- 결과 테이블 -->
  <table>
    <thead>
      <tr>
        <th>종목명 (티커)</th>
        <th>유사도 점수</th>
      </tr>
    </thead>
    <tbody id="resultTableBody"></tbody>
  </table>
</div>

<!-- 레이어 팝업 -->
<div id="layerBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:900;"></div>
<div id="stockLayerPopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); 
     width:90%; max-width:900px; background:#fff; padding:1rem; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.3); z-index:1000; overflow:auto; max-height:80vh;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
    <h3>KRX 종목 조회</h3>
    <button id="closeLayerBtn" style="background:#e53e3e; color:#fff; border:none; border-radius:4px; padding:0.3rem 0.6rem; cursor:pointer;">닫기</button>
  </div>
  <div class="toolbar" style="margin-bottom:0.5rem; display:flex; gap:0.5rem;">
    <input type="text" id="searchInput" placeholder="회사명 검색" style="flex:1; padding:0.5rem; border:1px solid #d1d5db; border-radius:5px;">
    <button id="fetchBtn" style="padding:0.5rem 1rem; background:#3b82f6; color:#fff; border:none; border-radius:5px; cursor:pointer;">조회</button>
  </div>
  <table style="width:100%; border-collapse:collapse;">
    <thead>
      <tr>
        <th>종목코드</th>
        <th>회사명</th>
        <th>상장일</th>
        <th>업종</th>
        <th>대표자</th>
      </tr>
    </thead>
    <tbody id="krxTableBody"></tbody>
  </table>
</div>


<th:block layout:fragment="pageScript">
<script>
document.addEventListener("DOMContentLoaded", () => {
    const companyInput = document.getElementById("company");
    const companyCodeInput = document.getElementById("companyCode");
    const startInput = document.getElementById("start");
    const endInput = document.getElementById("end");
    const nStocksInput = document.getElementById("nStocks");
    const searchBtn = document.getElementById("searchBtn");
    const loading = document.getElementById("loading");
    const warning = document.getElementById("warning");
    const resultTableBody = document.getElementById("resultTableBody");

    const layerPopup = document.getElementById("stockLayerPopup");
    const backdrop = document.getElementById("layerBackdrop");
    const openPopupBtn = document.getElementById("openSearchPopupBtn");
    const closePopupBtn = document.getElementById("closeLayerBtn");
    const searchInput = document.getElementById("searchInput");
    const fetchBtn = document.getElementById("fetchBtn");
    const krxTableBody = document.getElementById("krxTableBody");

    let allKrxStocks = [];

    // 레이어 팝업 이벤트
    openPopupBtn.addEventListener("click", () => {
        layerPopup.style.display = "block";
        backdrop.style.display = "block";
    });
    closePopupBtn.addEventListener("click", () => {
        layerPopup.style.display = "none";
        backdrop.style.display = "none";
    });
    backdrop.addEventListener("click", () => {
        layerPopup.style.display = "none";
        backdrop.style.display = "none";
    });

    // KRX 종목 조회 API 호출
    fetchBtn.addEventListener("click", () => {
        fetchBtn.disabled = true;
        fetchBtn.textContent = "조회 중...";
        // 백엔드에서 KRX 종목 목록을 가져오는 API 엔드포인트에 맞춰 URL 수정 필요
        fetch("/api/krx/stocks") 
            .then(res => res.json())
            .then(data => {
                allKrxStocks = data;
                renderKrxTable(allKrxStocks);
                fetchBtn.disabled = false;
                fetchBtn.textContent = "조회";
            })
            .catch(err => {
                console.error(err);
                alert("KRX 데이터 조회 중 오류 발생");
                fetchBtn.disabled = false;
                fetchBtn.textContent = "조회";
            });
    });
    
    // KRX 테이블 렌더링
    function renderKrxTable(data) {
        krxTableBody.innerHTML = "";
        const symbolCol = data.length > 0 && ('Symbol' in data[0] ? 'Symbol' : 'Code');
        data.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${item[symbolCol] || ''}</td>
                <td>${item.Name || ''}</td>
                <td>${item.ListingDate || ''}</td>
                <td>${item.Sector || ''}</td>
                <td>${item.Representative || ''}</td>
            `;
            tr.style.cursor = "pointer";
            tr.addEventListener("click", () => {
                companyInput.value = item.Name;
                // FinanceDataReader는 접미사 없이 6자리 코드만 사용
                companyCodeInput.value = item[symbolCol];
                layerPopup.style.display = "none";
                backdrop.style.display = "none";
            });
            krxTableBody.appendChild(tr);
        });
    }

    // 회사명 검색 필터링
    searchInput.addEventListener("keyup", (event) => {
        const keyword = event.target.value.toLowerCase();
        const symbolCol = allKrxStocks.length > 0 && ('Symbol' in allKrxStocks[0] ? 'Symbol' : 'Code');
        const filteredData = allKrxStocks.filter(item => 
            (item.Name && item.Name.toLowerCase().includes(keyword)) ||
            (item[symbolCol] && item[symbolCol].toLowerCase().includes(keyword))
        );
        renderKrxTable(filteredData);
    });

    // 유사 종목 분석 API 호출
    searchBtn.addEventListener("click", () => {
        const companyCode = companyCodeInput.value;
        const start = startInput.value;
        const end = endInput.value;
        const nStocks = nStocksInput.value;

        if (!companyCode || !start || !end) {
            warning.textContent = "기준 종목 코드와 날짜를 모두 입력해주세요.";
            return;
        }

        loading.classList.add("active");
        warning.textContent = "";
        resultTableBody.innerHTML = "";

        const url = `/api/krx/similar-advanced?companyCode=${companyCode}&start=${start}&end=${end}&nSimilarStocks=${nStocks}`;
        fetch(url)
            .then(res => {
                if (!res.ok) {
                    return res.json().then(errorData => {
                        throw new Error(errorData.message || 'API 호출 중 오류 발생');
                    });
                }
                return res.json();
            })
            .then(data => {
                loading.classList.remove("active");
                if (data.status === "success") {
                    renderResultTable(data.results);
                } else {
                    warning.textContent = `분석 실패: ${data.message}`;
                }
            })
            .catch(err => {
                loading.classList.remove("active");
                warning.textContent = `API 호출 중 오류 발생: ${err.message}`;
                console.error(err);
            });
    });

    // 결과 테이블 렌더링
    function renderResultTable(results) {
        resultTableBody.innerHTML = "";
        if (results && results.length > 0) {
            results.forEach(item => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td data-label="종목명 (티커)">${item.name || ''} (${item.ticker || ''})</td>
                    <td data-label="유사도 점수">${(item.cosine_similarity * 100).toFixed(2)}%</td>
                `;
                resultTableBody.appendChild(tr);
            });
        } else {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="2">결과가 없습니다.</td>`;
            resultTableBody.appendChild(tr);
        }
    }
});
</script>
</th:block>



</body>
</html>
