<!-- fragments/top.html -->
<div th:fragment="topFragment">
  <header class="top-bar">
    <div class="left-section">
      <button id="menuToggle" title="메뉴 열기/닫기">
        <i class="fas fa-bars"></i>
      </button>
      <h1>MyBaseLink</h1>
    </div>

    <div class="right-section">
      <div id="profileBtn" class="unified-btn" title="프로필">
        <i class="fas fa-user-circle"></i>
      </div>

      <div id="sessionStatusContainer" class="unified-btn" title="세션 상태">
        <i class="fas fa-clock" id="sessionTimerIcon"></i>
        <span id="sessionTimer">--:--</span>
        <button id="refreshSessionBtn" title="세션 연장">
          <i class="fas fa-rotate-right"></i>
        </button>
      </div>

      <button id="logoutBtn" class="unified-btn" title="로그아웃">
        <i class="fas fa-right-from-bracket"></i>
      </button>
    </div>
  </header>

  <!-- 프로필 레이어 -->
  <div id="profileLayer" class="profile-layer">
    <h3>내 프로필</h3>
    <label>이름:<input type="text" id="profileName" readonly></label>
    <label>이메일:<input type="email" id="profileEmail" placeholder="you@example.com"></label>
    <div class="profile-layer-btns">
      <button id="saveProfileBtn">저장</button>
      <button id="closeProfileBtn">닫기</button>
    </div>
  </div>

  <div id="sessionAlert" class="session-alert" style="display: none;"></div>

  <!-- 로딩 스피너 -->
  <div id="loadingSpinner" class="loading-spinner" style="display: none;">
    <div class="spinner"></div>
  </div>

  <!-- 토스트 -->
  <div id="toast-container" class="toast-container">
    <div id="single-toast" class="toast" style="display: none;"></div>
  </div>

  <style>
    :root {
      --primary-bg: #f3f4f6;
      --border-color: #d1d5db;
      --text-color: #111827;
      --unified-btn-bg: #e5e7eb;
      --unified-btn-text: #1f2937;
      --icon-color: #374151;
      --accent-color: #1e3a8a;
      --alert-info-bg: rgba(37, 99, 235, 0.15);
      --alert-info-text: #1e3a8a;
      --alert-warning-text: #f59e0b;
      --alert-danger-text: #dc2626;
      --profile-bg: #fff;
      --shadow-color: rgba(0, 0, 0, 0.1);
    }

    .top-bar {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 50px;
      display: flex; align-items: center;
      background: var(--primary-bg);
      border-bottom: 1px solid var(--border-color);
      color: var(--text-color);
      z-index: 4000; padding: 0 1rem;
      box-sizing: border-box;
    }

    .left-section { display:flex; align-items:center; gap:10px; }
    .top-bar h1 { margin:0; font-size:1.1rem; font-weight:600; white-space:nowrap; }

    .right-section {
      position:absolute; right:.6rem;
      display:flex; align-items:center; gap:8px;
    }

    .unified-btn {
      display:flex; align-items:center; justify-content:center; gap:6px;
      height:36px; min-width:36px; padding:0 10px;
      background:var(--unified-btn-bg); color:var(--unified-btn-text);
      border-radius:6px; font-size:14px; cursor:pointer; border:none;
      transition:all .2s;
    }
    .unified-btn:hover { background:#d1d5db; }
    .unified-btn i { font-size:16px; color:var(--icon-color); transition:color .2s; }

    #sessionStatusContainer { gap:6px; }
    #sessionTimer { font-weight:600; }
    #sessionTimer.warning { color:var(--alert-warning-text); }
    #sessionTimer.danger { color:var(--alert-danger-text); }

    #refreshSessionBtn {
      background:none; border:none; color:var(--icon-color);
      cursor:pointer; padding:0; margin-left:4px; opacity:.6; transition:.2s;
    }
    #refreshSessionBtn:hover { opacity:1; }
    #refreshSessionBtn:disabled { cursor:not-allowed; opacity:.3; }

    .profile-layer {
      position:absolute; top:60px; right:1rem;
      width:250px; background:var(--profile-bg);
      border:1px solid var(--border-color); border-radius:8px;
      padding:10px; box-shadow:0 4px 6px var(--shadow-color);
      display:none; z-index:5000; color:var(--text-color);
    }

    .session-alert {
      position:fixed; top:60px; right:1rem;
      background:var(--alert-info-bg); color:var(--alert-info-text);
      padding:6px 10px; border-radius:6px; font-size:13px;
      box-shadow:0 2px 6px var(--shadow-color);
      opacity:.9; z-index:6000;
    }

    .loading-spinner {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,.4); z-index:9999; display:none;
      justify-content:center; align-items:center;
    }
    .spinner {
      border:4px solid #f3f4f6; border-top:4px solid var(--accent-color);
      border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    .toast-container { position:fixed; top:60px; right:1rem; z-index:7000; }
    #single-toast { padding:12px 20px; border-radius:8px; color:#fff; font-size:14px;
      box-shadow:0 4px 12px rgba(0,0,0,.1); opacity:1; transition:opacity .5s, transform .5s; }
    #single-toast.hide { opacity:0; transform:translateY(-20px); }
    #single-toast.success { background:#4caf50; } #single-toast.error { background:#f44336; }
    #single-toast.warning { background:#ff9800; } #single-toast.info { background:#2196f3; }

    @media(max-width:640px){
      .right-section{right:.5rem;gap:6px;}
      .profile-layer{right:.5rem;width:220px;}
      .unified-btn{font-size:13px;padding:0 8px;}
    }
  </style>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const toast = document.getElementById("single-toast");
    const spinner = document.getElementById("loadingSpinner");
    const sessionTimer = document.getElementById("sessionTimer");
    const refreshBtn = document.getElementById("refreshSessionBtn");
    const profileLayer = document.getElementById("profileLayer");

    /* ========= 공통 토스트 ========= */
    function showToast(type, msg) {
      toast.className = `toast ${type}`;
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(()=>toast.classList.add("hide"),2200);
      setTimeout(()=>toast.style.display="none",2700);
    }

    /* ========= 메뉴 토글(하드가드) =========
       1) window.toggleSidebar()가 있으면 그걸 호출
       2) 없으면 사이드바 후보 셀렉터들을 순회해 open/collapsed 토글
       3) 그래도 안되면 body.menu-open 토글
       4) 상태를 localStorage에 저장/복원
       5) 'sidebar:toggle' 이벤트 브로드캐스트
    */
    const menuBtn = document.getElementById("menuToggle");
    const SIDEBAR_SELECTORS = [
      "aside.sidebar", "#left", "#leftMenu", "#sidebar", ".left-menu", "#leftPanel"
    ];
    const STATE_KEY = "sidebar_state"; // 'open' | 'closed'

    function getSidebarEl() {
      for (const sel of SIDEBAR_SELECTORS) {
        const el = document.querySelector(sel);
        if (el) return el;
      }
      return null;
    }

    function applySidebarState(state) {
      const sidebar = getSidebarEl();
      if (sidebar) {
        if (state === "open") {
          sidebar.classList.add("open");
          sidebar.classList.remove("collapsed");
        } else {
          sidebar.classList.remove("open");
          sidebar.classList.add("collapsed");
        }
      } else {
        // 사이드바를 못 찾을 때는 body에 토글 적용
        if (state === "open") document.body.classList.add("menu-open");
        else document.body.classList.remove("menu-open");
      }
    }

    // 초기 복원
    (function restoreSidebar() {
      const saved = localStorage.getItem(STATE_KEY);
      if (saved === "open" || saved === "closed") {
        applySidebarState(saved);
      }
    })();

    function broadcastToggle(state) {
      try {
        document.dispatchEvent(new CustomEvent("sidebar:toggle", { detail: { state } }));
      } catch {}
    }

    async function hardToggleSidebar() {
      // 1) 사용자 정의 함수 우선
      if (typeof window.toggleSidebar === "function") {
        try {
          const result = window.toggleSidebar();
          // 반환값이 있으면 상태로 간주
          if (result === "open" || result === "closed") {
            localStorage.setItem(STATE_KEY, result);
            broadcastToggle(result);
            return;
          }
        } catch {}
      }

      // 2) 사이드바 후보를 찾아 클래스로 토글
      const sidebar = getSidebarEl();
      if (sidebar) {
        const willOpen = sidebar.classList.contains("collapsed") || !sidebar.classList.contains("open");
        if (willOpen) {
          sidebar.classList.add("open");
          sidebar.classList.remove("collapsed");
          localStorage.setItem(STATE_KEY, "open");
          broadcastToggle("open");
        } else {
          sidebar.classList.remove("open");
          sidebar.classList.add("collapsed");
          localStorage.setItem(STATE_KEY, "closed");
          broadcastToggle("closed");
        }
        return;
      }

      // 3) 최후: body 토글
      const willOpen = !document.body.classList.contains("menu-open");
      document.body.classList.toggle("menu-open");
      localStorage.setItem(STATE_KEY, willOpen ? "open" : "closed");
      broadcastToggle(willOpen ? "open" : "closed");
    }

    menuBtn?.addEventListener("click", hardToggleSidebar);

    /* ========= 프로필 ========= */
    const profileBtn = document.getElementById("profileBtn");
    profileBtn?.addEventListener("click", async ()=>{
      if (profileLayer.style.display === "block") {
        profileLayer.style.display = "none";
        return;
      }
      try{
        spinner.style.display = "flex";
        const res = await fetch("/auth/me",{credentials:"include"});
        spinner.style.display = "none";
        if(!res.ok) throw new Error();
        const data = await res.json();
        document.getElementById("profileName").value = data.name || "";
        document.getElementById("profileEmail").value = data.email || "";
        profileLayer.style.display = "block";
      }catch{
        spinner.style.display = "none";
        showToast("error","로그인이 필요합니다.");
      }
    });
    document.getElementById("closeProfileBtn")?.addEventListener("click",()=>profileLayer.style.display="none");
    document.getElementById("saveProfileBtn")?.addEventListener("click",()=>showToast("info","프로필 저장 기능은 준비 중입니다."));

    /* ========= 로그아웃 ========= */
    document.getElementById("logoutBtn")?.addEventListener("click", async ()=>{
      spinner.style.display = "flex";
      await fetch("/auth/logout",{method:"POST",credentials:"include"});
      spinner.style.display = "none";
      localStorage.clear();
      location.href = "/login";
    });

    /* ========= 세션 타이머 ========= */
    let remaining = parseInt(localStorage.getItem("sessionMillis")||"0",10);
    if (remaining > 0) {
      setInterval(()=>{
        remaining -= 1000;
        const m = Math.floor(remaining/60000);
        const s = Math.floor((remaining%60000)/1000);
        sessionTimer.textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
        if (remaining < 60000) sessionTimer.classList.add("danger");
        else if (remaining < 180000) sessionTimer.classList.add("warning");
        if (remaining <= 0) {
          showToast("error","세션이 만료되었습니다.");
          setTimeout(()=>location.href="/login",1500);
        }
      }, 1000);
    } else {
      sessionTimer.textContent = "--:--";
    }

    /* ========= 세션 연장 ========= */
    refreshBtn?.addEventListener("click", async ()=>{
      try{
        spinner.style.display = "flex";
        const res = await fetch("/auth/refresh",{method:"POST",credentials:"include"});
        spinner.style.display = "none";
        if (res.ok) {
          const data = await res.json();
          localStorage.setItem("sessionMillis", data.sessionMillis);
          remaining = data.sessionMillis;
          showToast("success","세션이 연장되었습니다.");
        } else {
          showToast("error","세션 연장 실패");
        }
      }catch{
        spinner.style.display = "none";
        showToast("error","서버 연결 오류");
      }
    });
  });
  </script>
</div>
