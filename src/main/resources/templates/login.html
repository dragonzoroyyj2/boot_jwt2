<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MyBaseLink Î°úÍ∑∏Ïù∏</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
<link rel="manifest" href="/favicon/manifest.json">
<meta name="theme-color" content="#ffffff">
<style>
body {
  margin: 0; min-height: 100vh; display: flex; flex-direction: column;
  justify-content: center; align-items: center;
  font-family: "Pretendard", "Noto Sans KR", sans-serif;
  background: linear-gradient(135deg, #e5e7eb, #9ca3af, #6b7280); color: #fff;
}
.login-container {
  width: 100%; max-width: 340px; margin: 0 5vw; padding: 2rem 1.5rem;
  background: rgba(255,255,255,0.15); border-radius: 16px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.25); backdrop-filter: blur(12px);
  text-align: center; color: #fff; animation: fadeIn .9s ease;
  box-sizing: border-box; border: 1px solid rgba(255,255,255,0.2); position: relative; z-index: 2;
}
.chart-container { width: 90%; max-width: 300px; height: 150px; margin: 0 auto 1.5px; position: relative; z-index:1; }
#toggleRepeatIcon { position:absolute; top:5px; left:5px; font-size:22px; color: rgba(255,255,255,0.9); cursor:pointer; z-index:10; transition:.2s; }
.login-container h2 { margin-bottom: 1.2rem; font-weight: 700; font-size: 1.3rem; letter-spacing: .5px; }
.input-group { position: relative; margin-bottom: 1rem; width: 100%; }
.input-group input {
  width: 100%; padding: 10px 40px 10px 14px; border: none; border-radius: 10px;
  outline: none; background: rgba(255,255,255,0.9); color: #333; font-size: .9rem; transition: .25s; box-sizing: border-box;
}
.input-group input:focus { background:#fff; box-shadow: 0 0 0 2px #9ca3af; }
.input-group i { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: #666; font-size: .9rem; }
button {
  width:100%; padding:10px; border:none; border-radius:10px; background: linear-gradient(90deg,#6b7280,#4b5563);
  color:#fff; font-weight:bold; cursor:pointer; transition:.3s; font-size:.95rem; margin-top:.5rem; box-sizing:border-box;
}
button:hover { background: linear-gradient(90deg,#4b5563,#374151); transform: translateY(-2px); }
.login-footer { margin-top:1rem; font-size:.8rem; color:#d1d5db; }
.login-footer a { color:#e5e7eb; text-decoration:none; }
.login-footer a:hover { text-decoration: underline; }
@keyframes fadeIn { from{opacity:0; transform: translateY(15px);} to{opacity:1; transform: translateY(0);} }
@media (max-width:400px){
  .login-container{padding:1.8rem 1.2rem;margin:0 6vw;}
  .input-group input, button{padding-left:14px;padding-right:40px;}
  .chart-container{max-width:260px;}
}
</style>
</head>

<body>

<div class="chart-container">
  <canvas id="candleChart" width="300" height="150"></canvas>
  <i id="toggleRepeatIcon" class="fas fa-pause-circle" title="Î∞òÎ≥µ ÏãúÏûë/Ï†ïÏßÄ"></i>
</div>

<div class="login-container">
  <h2>üîê MyBaseLink Î°úÍ∑∏Ïù∏</h2>

  <div class="input-group">
    <input type="text" id="username" placeholder="ÏïÑÏù¥Îîî" />
    <i class="fas fa-user"></i>
  </div>

  <div class="input-group">
    <input type="password" id="password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" />
    <i class="fas fa-lock"></i>
  </div>

  <button id="loginBtn">Î°úÍ∑∏Ïù∏</button>

  <div class="login-footer">
    <p>Í≥ÑÏ†ïÏù¥ ÏóÜÎÇòÏöî? <a href="#">ÌöåÏõêÍ∞ÄÏûÖ</a></p>
  </div>
</div>

<script>
// === Î°úÍ∑∏Ïù∏ ===
(function(){
  const loginBtn = document.getElementById("loginBtn");
  const usernameEl = document.getElementById("username");
  const passwordEl = document.getElementById("password");

  async function doLogin(){
    const username = usernameEl.value.trim();
    const password = passwordEl.value.trim();
    if(!username || !password){ alert("ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî."); return; }

    loginBtn.disabled = true;
    const oldLabel = loginBtn.textContent;
    loginBtn.textContent = "Î°úÍ∑∏Ïù∏ Ï§ë...";

    try{
      const res = await fetch("/auth/login", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        credentials: "include", // ‚úÖ HttpOnly Ïø†ÌÇ§ ÏàòÏã†
        body: JSON.stringify({ username, password })
      });

      if(res.ok){
        const data = await res.json();
        // JWTÎäî Ï†ÄÏû•ÌïòÏßÄ ÏïäÏùå(Ïø†ÌÇ§). ÌÉÄÏù¥Î®∏Îßå ÎèôÍ∏∞Ìôî(ÏòµÏÖò)
        if(data.serverTime && data.sessionMillis){
          localStorage.setItem("serverTime", data.serverTime);
          localStorage.setItem("sessionMillis", data.sessionMillis);
        }
        if(data.username){
          localStorage.setItem("username", data.username);
        }
        location.href = "/pages/main/base";
      }else{
        const err = await res.json().catch(()=>({}));
        alert(err.error || "Î°úÍ∑∏Ïù∏ Ïã§Ìå® ‚ùå");
        loginBtn.disabled = false;
        loginBtn.textContent = oldLabel;
      }
    }catch(e){
      alert("ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
      loginBtn.disabled = false;
      loginBtn.textContent = oldLabel;
    }
  }

  loginBtn.addEventListener("click", doLogin);
  [usernameEl, passwordEl].forEach(el => el.addEventListener("keydown", e => {
    if(e.key === "Enter") doLogin();
  }));
})();

// === ÏïÑÎûòÎäî Í∏∞Ï°¥ Ï∞®Ìä∏ Ïï†ÎãàÎ©îÏù¥ÏÖò(ÎîîÏûêÏù∏ Ïú†ÏßÄ) ===
let repeatChart = true;
let animationId = null;
let chartOpacity = 0.7;
let holdTime=0;
const icon = document.getElementById("toggleRepeatIcon");

function updateIcon(){
  if(repeatChart){
    icon.className="fas fa-pause-circle";
    icon.style.color="rgba(255,255,255,0.9)";
    icon.title="Î∞òÎ≥µ Ï§ë (ÌÅ¥Î¶≠ Ïãú Ï§ëÏßÄ)";
  } else {
    icon.className="fas fa-play-circle";
    icon.style.color="rgba(255,255,255,0.6)";
    icon.title="Î∞òÎ≥µ Ï§ëÏßÄ (ÌÅ¥Î¶≠ Ïãú ÏãúÏûë)";
  }
}
icon.addEventListener("click", ()=>{
  repeatChart=!repeatChart; updateIcon();
  if(repeatChart && animationId===null){ fadeOpacity=chartOpacity; drawCandles(); }
  else if(!repeatChart && animationId!==null){ cancelAnimationFrame(animationId); animationId=null; }
});
updateIcon();

const candleCount=13;
let candles=[],index=0,fadeOpacity=chartOpacity;
const canvas=document.getElementById("candleChart");
const ctx=canvas.getContext("2d");
const width = 15;

function resetCandles(){
  candles=[]; index=0; fadeOpacity=chartOpacity; holdTime=0;
  const minH=20;
  for(let i=0;i<candleCount-1;i++){
    let base=minH+i*5;
    let noise=Math.floor(Math.random()*10)-5;
    let height=base+noise;
    const color=(i%2===0)?`rgba(59,130,246,${0.5+Math.random()*0.2})`:`rgba(239,68,68,${0.5+Math.random()*0.2})`;
    candles.push({targetHeight:height,currentHeight:0,color});
  }
  const lastHeight=Math.floor(candles[candleCount-2].targetHeight*1.3);
  candles.push({targetHeight:lastHeight,currentHeight:0,color:`rgba(239,68,68,0.9)`});
}

function drawCandles(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const spacing=(canvas.width-candleCount*width)/(candleCount-1);

  for(let i=0;i<=index;i++){
    const c=candles[i];
    const speed=(i===candleCount-1)?6:3+Math.random()*2;
    if(c.currentHeight<c.targetHeight)c.currentHeight+=speed;
    if(c.currentHeight>c.targetHeight)c.currentHeight=c.targetHeight;
    const x=i*(width+spacing);
    const y=canvas.height-c.currentHeight;
    ctx.fillStyle=c.color;
    ctx.fillRect(x,y,width,c.currentHeight);
  }

  const gradient=ctx.createLinearGradient(0,0,canvas.width,0);
  gradient.addColorStop(0,"rgba(248,113,113,"+fadeOpacity+")");
  gradient.addColorStop(0.5,"rgba(59,130,246,"+fadeOpacity+")");
  gradient.addColorStop(1,"rgba(248,113,113,"+fadeOpacity+")");

  ctx.beginPath(); ctx.strokeStyle=gradient; ctx.lineWidth=2;
  for(let i=0;i<=index;i++){
    const c=candles[i];
    const x=i*(width+spacing)+width/2;
    const y=canvas.height-c.currentHeight-10;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  if(index>=candleCount-1){
    const last=candles[candleCount-1];
    const lx=canvas.width-width/2-1;
    const ly=canvas.height-last.currentHeight-10;
    const arrowWidth=Math.min(22,canvas.width-lx-2);
    const arrowHeight=14;

    const glowAlpha=0.5+0.5*Math.sin(Date.now()/100);
    ctx.beginPath();
    ctx.moveTo(lx, ly-arrowHeight/2);
    ctx.lineTo(lx, ly+arrowHeight/2);
    ctx.lineTo(lx+arrowWidth, ly);
    ctx.closePath();
    ctx.fillStyle=`rgba(248,113,113,${glowAlpha})`;
    ctx.fill();

    ctx.fillStyle=`rgba(255,255,255,${0.2+0.3*Math.sin(Date.now()/80)})`;
    for(let i=0;i<5;i++){
      const offsetX=Math.random()*2;
      const offsetY=Math.random()*2-1;
      ctx.beginPath();
      ctx.arc(lx+arrowWidth, ly+offsetY,1.5,0,2*Math.PI);
      ctx.fill();
    }
  }

  if(index<candleCount-1 && candles[index].currentHeight>=candles[index].targetHeight) index++;
  if(index>=candleCount-1){ if(holdTime<45){holdTime++;} else {fadeOpacity-=0.02; if(fadeOpacity<0)fadeOpacity=0;} }

  if(fadeOpacity>0){ animationId=requestAnimationFrame(drawCandles); }
  else { animationId=null; if(repeatChart){ setTimeout(()=>{ resetCandles(); drawCandles(); },2000);} }
}

resetCandles();
drawCandles();
</script>

</body>
</html>
